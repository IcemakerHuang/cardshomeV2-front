import{a4 as X,x as u,ae as Y,a5 as j,af as G,c as l,a7 as s,ai as J,Y as Q,ac as W,X as w,ab as B,aa as T,aT as Z,V as ee,a6 as ae,am as le,a8 as t,a9 as te,aj as oe,ar as se,ao as re,ak as ue,al as ne,ag as ie,an as de,T as me}from"./index-8230ba90.js";import{c as ce,a as D,e as pe,f as ve,u as ge,d as p,V as Ve}from"./index.esm-d1883ded.js";import{a as fe,V as I}from"./VCol-b62a3033.js";import{V as be}from"./VRow-9d4bbb38.js";import{V as ye}from"./VDivider-ccc7c20e.js";import{V as ke,a as xe,b as Ce}from"./VTextarea-e1ec175b.js";import{a as we}from"./VDataTable-b6d68c52.js";import"./VList-dd04644e.js";import"./ssrBoot-55d8ca2a.js";import"./VSlideGroup-99b8cb2e.js";const Be=de("h1",{class:"text-center"},"商品管理",-1),qe={__name:"ProductsView",setup(Se){const{apiAuth:S}=W(),P=X(),$=u(null),v=u(!1),n=u(""),q=r=>{r?(n.value=r._id,g.value.value=r.name,V.value.value=r.price,f.value.value=r.description,b.value.value=r.category,y.value.value=r.sell):n.value="",v.value=!0},N=()=>{v.value=!1,K(),$.value.deleteFileRecord()},R=["地區回饋","愛心公益","學校認同","市民卡","公會組織"],z=ce({name:D().required("缺少商品名稱"),price:pe().typeError("商品價格格式錯誤").required("缺少商品價格").min(0,"商品價格不能小於 0"),description:D().required("缺少商品說明"),category:D().required("缺少商品分類").test("isCategory","商品分類錯誤",r=>R.includes(r)),sell:ve()}),{handleSubmit:E,isSubmitting:U,resetForm:K}=ge({validationSchema:z,initialValues:{name:"",price:0,description:"",category:"",sell:!1}}),g=p("name"),V=p("price"),f=p("description"),b=p("category"),y=p("sell"),d=u([]),L=u([]),H=E(async r=>{var a,i,e;if(!((a=d.value[0])!=null&&a.error)&&!(n.value===""&&d.value.length===0))try{const o=new FormData;for(const m in r)o.append(m,r[m]);d.value.length>0&&o.append("image",d.value[0].file),n.value===""?await S.post("/products",o):await S.patch("/products/"+n.value,o),P({text:n.value===""?"新增成功":"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),N(),h()}catch(o){console.log(o);const m=((e=(i=o==null?void 0:o.response)==null?void 0:i.data)==null?void 0:e.message)||"發生錯誤，請稍後再試";P({text:m,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),F=u(10),k=u([{key:"createdAt",order:"desc"}]),x=u(1),M=u([]),O=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"名稱",align:"center",sortable:!0,key:"name"},{title:"申請費用",align:"center",sortable:!0,key:"price"},{title:"分類",align:"center",sortable:!0,key:"category"},{title:"上架",align:"center",sortable:!0,key:"sell"},{title:"編輯",align:"center",sortable:!1,key:"edit"}],A=u(!0),_=u(0),C=u(""),c=async()=>{var r,a,i,e;A.value=!0;try{const{data:o}=await S.get("/products/all",{params:{page:x.value,itemsPerPage:F.value,sortBy:((r=k.value[0])==null?void 0:r.key)||"createdAt",sortOrder:((a=k.value[0])==null?void 0:a.order)==="asc"?1:-1,search:C.value}});M.value.splice(0,M.value.length,...o.result.data),_.value=o.result.total}catch(o){console.log(o);const m=((e=(i=o==null?void 0:o.response)==null?void 0:i.data)==null?void 0:e.message)||"發生錯誤，請稍後再試";P({text:m,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}A.value=!1};c();const h=()=>{x.value=1,c()};return(r,a)=>{const i=Y("VueFileAgent");return j(),G(Q,null,[l(fe,null,{default:s(()=>[l(be,null,{default:s(()=>[l(I,{cols:"12"},{default:s(()=>[Be]),_:1}),l(ye),l(I,{cols:"12"},{default:s(()=>[l(w,{color:"green",onClick:a[0]||(a[0]=e=>q())},{default:s(()=>[B("新增商品")]),_:1})]),_:1}),l(I,{cols:"12"},{default:s(()=>[l(ke,{"items-per-page":F.value,"onUpdate:itemsPerPage":[a[2]||(a[2]=e=>F.value=e),c],"sort-by":k.value,"onUpdate:sortBy":[a[3]||(a[3]=e=>k.value=e),c],page:x.value,"onUpdate:page":[a[4]||(a[4]=e=>x.value=e),c],items:M.value,headers:O,loading:A.value,"items-length":_.value,search:C.value,hover:""},{top:s(()=>[l(T,{label:"搜尋","append-icon":"mdi-magnify",modelValue:C.value,"onUpdate:modelValue":a[1]||(a[1]=e=>C.value=e),"onClick:append":h,onKeydown:Z(h,["enter"])},null,8,["modelValue"])]),"item.image":s(({item:e})=>[l(ee,{src:e.image,height:"50px"},null,8,["src"])]),"item.sell":s(({item:e})=>[e.sell?(j(),ae(me,{key:0,icon:"mdi-check"})):le("",!0)]),"item.edit":s(({item:e})=>[l(w,{icon:"mdi-pencil",variant:"text",color:"blue",onClick:o=>q(e)},null,8,["onClick"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"])]),_:1})]),_:1})]),_:1}),l(J,{modelValue:v.value,"onUpdate:modelValue":a[12]||(a[12]=e=>v.value=e),persistent:"",width:"500px"},{default:s(()=>[l(Ve,{disabled:t(U),onSubmit:te(t(H),["prevent"])},{default:s(()=>[l(oe,null,{default:s(()=>[l(se,null,{default:s(()=>[B(re(n.value===""?"新增商品":"編輯商品"),1)]),_:1}),l(ue,null,{default:s(()=>[l(T,{label:"名稱",modelValue:t(g).value.value,"onUpdate:modelValue":a[5]||(a[5]=e=>t(g).value.value=e),"error-messages":t(g).errorMessage.value},null,8,["modelValue","error-messages"]),l(T,{label:"價格",type:"number",min:"0",modelValue:t(V).value.value,"onUpdate:modelValue":a[6]||(a[6]=e=>t(V).value.value=e),"error-messages":t(V).errorMessage.value},null,8,["modelValue","error-messages"]),l(we,{label:"分類",items:R,modelValue:t(b).value.value,"onUpdate:modelValue":a[7]||(a[7]=e=>t(b).value.value=e),"error-messages":t(b).errorMessage.value},null,8,["modelValue","error-messages"]),l(xe,{label:"上架",modelValue:t(y).value.value,"onUpdate:modelValue":a[8]||(a[8]=e=>t(y).value.value=e),"error-messages":t(y).errorMessage.value},null,8,["modelValue","error-messages"]),l(Ce,{label:"說明",modelValue:t(f).value.value,"onUpdate:modelValue":a[9]||(a[9]=e=>t(f).value.value=e),"error-messages":t(f).errorMessage.value},null,8,["modelValue","error-messages"]),l(i,{modelValue:d.value,"onUpdate:modelValue":a[10]||(a[10]=e=>d.value=e),rawModelValue:L.value,"onUpdate:rawModelValue":a[11]||(a[11]=e=>L.value=e),accept:"image/jpeg,image/png",deletable:"","error-text":{type:"檔案格式不支援",size:"檔案超過 1MB 大小限制"},"help-text":"選擇檔案或拖曳到這裡","max-files":1,"max-size":"1MB",ref_key:"fileAgent",ref:$},null,8,["modelValue","rawModelValue"])]),_:1}),l(ne,null,{default:s(()=>[l(ie),l(w,{color:"red",disabled:t(U),onClick:N},{default:s(()=>[B("取消")]),_:1},8,["disabled"]),l(w,{color:"green",type:"submit",loading:t(U)},{default:s(()=>[B("送出")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64)}}};export{qe as default};
