import{p as ue,aU as ie,aV as de,g as ce,aW as ve,D as me,aX as fe,o as $,x as c,s as ge,H as pe,A as Ve,z as T,B as xe,u as ye,aY as be,aZ as ae,a_ as we,c as t,a$ as he,G as K,Y as q,R as te,aF as ke,b0 as Ce,b1 as Fe,Z as Pe,at as X,b2 as Se,v as Be,y as Ie,a4 as Me,af as Re,a5 as le,ag as Ae,a7 as d,ak as Ue,ac as Te,X as E,ab as G,aa as Y,b3 as De,V as Ne,a6 as _e,ao as ze,a8 as u,a9 as He,al as $e,ar as Ee,ap as Ge,am as qe,an as Oe,ai as Le,ah as je,T as Ke}from"./index-5ce089e2.js";import{c as Xe,a as Z,e as Ye,f as Ze,u as We,d as D}from"./index.esm-296a1124.js";import{a as Je,V as W}from"./VCol-59da8031.js";import{V as Qe}from"./VRow-b14cd141.js";import{V as ea}from"./VDivider-12e94bce.js";import{V as aa,a as ta}from"./VDataTableServer-a21352fd.js";import{V as la}from"./VForm-e05e629d.js";import{a as oa}from"./VDataTable-e289e3b2.js";import"./VList-1fc7e00e.js";import"./ssrBoot-ca2c81c4.js";import"./VSlideGroup-0a682ae1.js";const na=ue({autoGrow:Boolean,autofocus:Boolean,counter:[Boolean,Number,String],counterValue:Function,prefix:String,placeholder:String,persistentPlaceholder:Boolean,persistentCounter:Boolean,noResize:Boolean,rows:{type:[Number,String],default:5,validator:e=>!isNaN(parseFloat(e))},maxRows:{type:[Number,String],validator:e=>!isNaN(parseFloat(e))},suffix:String,modelModifiers:Object,...ie(),...de()},"VTextarea"),sa=ce()({name:"VTextarea",directives:{Intersect:ve},inheritAttrs:!1,props:na(),emits:{"click:control":e=>!0,"mousedown:control":e=>!0,"update:focused":e=>!0,"update:modelValue":e=>!0},setup(e,M){let{attrs:P,emit:R,slots:m}=M;const i=me(e,"modelValue"),{isFocused:h,focus:N,blur:_}=fe(e),O=$(()=>typeof e.counterValue=="function"?e.counterValue(i.value):(i.value||"").toString().length),L=$(()=>{if(P.maxlength)return P.maxlength;if(!(!e.counter||typeof e.counter!="number"&&typeof e.counter!="string"))return e.counter});function A(o,v){var r,f;!e.autofocus||!o||(f=(r=v[0].target)==null?void 0:r.focus)==null||f.call(r)}const z=c(),x=c(),S=ge(""),y=c(),I=$(()=>e.persistentPlaceholder||h.value||e.active);function k(){var o;y.value!==document.activeElement&&((o=y.value)==null||o.focus()),h.value||N()}function C(o){k(),R("click:control",o)}function H(o){R("mousedown:control",o)}function j(o){o.stopPropagation(),k(),X(()=>{i.value="",Se(e["onClick:clear"],o)})}function U(o){var r;const v=o.target;if(i.value=v.value,(r=e.modelModifiers)!=null&&r.trim){const f=[v.selectionStart,v.selectionEnd];X(()=>{v.selectionStart=f[0],v.selectionEnd=f[1]})}}const p=c(),b=c(+e.rows),B=$(()=>["plain","underlined"].includes(e.variant));pe(()=>{e.autoGrow||(b.value=+e.rows)});function F(){e.autoGrow&&X(()=>{if(!p.value||!x.value)return;const o=getComputedStyle(p.value),v=getComputedStyle(x.value.$el),r=parseFloat(o.getPropertyValue("--v-field-padding-top"))+parseFloat(o.getPropertyValue("--v-input-padding-top"))+parseFloat(o.getPropertyValue("--v-field-padding-bottom")),f=p.value.scrollHeight,s=parseFloat(o.lineHeight),l=Math.max(parseFloat(e.rows)*s+r,parseFloat(v.getPropertyValue("--v-input-control-height"))),V=parseFloat(e.maxRows)*s+r||1/0,a=Ie(f??0,l,V);b.value=Math.floor((a-r)/s),S.value=Be(a)})}Ve(F),T(i,F),T(()=>e.rows,F),T(()=>e.maxRows,F),T(()=>e.density,F);let g;return T(p,o=>{o?(g=new ResizeObserver(F),g.observe(p.value)):g==null||g.disconnect()}),xe(()=>{g==null||g.disconnect()}),ye(()=>{const o=!!(m.counter||e.counter||e.counterValue),v=!!(o||m.details),[r,f]=be(P),{modelValue:s,...l}=ae.filterProps(e),V=we(e);return t(ae,K({ref:z,modelValue:i.value,"onUpdate:modelValue":a=>i.value=a,class:["v-textarea v-text-field",{"v-textarea--prefixed":e.prefix,"v-textarea--suffixed":e.suffix,"v-text-field--prefixed":e.prefix,"v-text-field--suffixed":e.suffix,"v-textarea--auto-grow":e.autoGrow,"v-textarea--no-resize":e.noResize||e.autoGrow,"v-input--plain-underlined":B.value},e.class],style:e.style},r,l,{centerAffix:b.value===1&&!B.value,focused:h.value}),{...m,default:a=>{let{id:n,isDisabled:w,isDirty:J,isReadonly:oe,isValid:ne}=a;return t(he,K({ref:x,style:{"--v-textarea-control-height":S.value},onClick:C,onMousedown:H,"onClick:clear":j,"onClick:prependInner":e["onClick:prependInner"],"onClick:appendInner":e["onClick:appendInner"]},V,{id:n.value,active:I.value||J.value,centerAffix:b.value===1&&!B.value,dirty:J.value||e.dirty,disabled:w.value,focused:h.value,error:ne.value===!1}),{...m,default:se=>{let{props:{class:Q,...ee}}=se;return t(q,null,[e.prefix&&t("span",{class:"v-text-field__prefix"},[e.prefix]),te(t("textarea",K({ref:y,class:Q,value:i.value,onInput:U,autofocus:e.autofocus,readonly:oe.value,disabled:w.value,placeholder:e.placeholder,rows:e.rows,name:e.name,onFocus:k,onBlur:_},ee,f),null),[[ke("intersect"),{handler:A},null,{once:!0}]]),e.autoGrow&&te(t("textarea",{class:[Q,"v-textarea__sizer"],id:`${ee.id}-sizer`,"onUpdate:modelValue":re=>i.value=re,ref:p,readonly:!0,"aria-hidden":"true"},null),[[Ce,i.value]]),e.suffix&&t("span",{class:"v-text-field__suffix"},[e.suffix])])}})},details:v?a=>{var n;return t(q,null,[(n=m.details)==null?void 0:n.call(m,a),o&&t(q,null,[t("span",null,null),t(Fe,{active:e.persistentCounter||h.value,value:O.value,max:L.value},m.counter)])])}:void 0})}),Pe({},z,x,y)}}),ra=je("h1",{class:"text-center"},"商品管理",-1),ya={__name:"ProductsView",setup(e){const{apiAuth:M}=Te(),P=Me(),R=c(null),m=c(!1),i=c(""),h=s=>{s?(i.value=s._id,x.value.value=s.name,S.value.value=s.price,y.value.value=s.description,I.value.value=s.category,k.value.value=s.sell):i.value="",m.value=!0},N=()=>{m.value=!1,z(),R.value.deleteFileRecord()},_=["地區回饋","愛心公益","學校認同","市民卡","公會組織"],O=Xe({name:Z().required("缺少商品名稱"),price:Ye().typeError("商品價格格式錯誤").required("缺少商品價格").min(0,"商品價格不能小於 0"),description:Z().required("缺少商品說明"),category:Z().required("缺少商品分類").test("isCategory","商品分類錯誤",s=>_.includes(s)),sell:Ze()}),{handleSubmit:L,isSubmitting:A,resetForm:z}=We({validationSchema:O,initialValues:{name:"",price:0,description:"",category:"",sell:!1}}),x=D("name"),S=D("price"),y=D("description"),I=D("category"),k=D("sell"),C=c([]),H=c([]),j=L(async s=>{var l,V,a;if(!((l=C.value[0])!=null&&l.error)&&!(i.value===""&&C.value.length===0))try{const n=new FormData;for(const w in s)n.append(w,s[w]);C.value.length>0&&n.append("image",C.value[0].file),i.value===""?await M.post("/products",n):await M.patch("/products/"+i.value,n),P({text:i.value===""?"新增成功":"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),N(),f()}catch(n){console.log(n);const w=((a=(V=n==null?void 0:n.response)==null?void 0:V.data)==null?void 0:a.message)||"發生錯誤，請稍後再試";P({text:w,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),U=c(10),p=c([{key:"createdAt",order:"desc"}]),b=c(1),B=c([]),F=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"名稱",align:"center",sortable:!0,key:"name"},{title:"申請費用",align:"center",sortable:!0,key:"price"},{title:"分類",align:"center",sortable:!0,key:"category"},{title:"上架",align:"center",sortable:!0,key:"sell"},{title:"編輯",align:"center",sortable:!1,key:"edit"}],g=c(!0),o=c(0),v=c(""),r=async()=>{var s,l,V,a;g.value=!0;try{const{data:n}=await M.get("/products/all",{params:{page:b.value,itemsPerPage:U.value,sortBy:((s=p.value[0])==null?void 0:s.key)||"createdAt",sortOrder:((l=p.value[0])==null?void 0:l.order)==="asc"?1:-1,search:v.value}});B.value.splice(0,B.value.length,...n.result.data),o.value=n.result.total}catch(n){console.log(n);const w=((a=(V=n==null?void 0:n.response)==null?void 0:V.data)==null?void 0:a.message)||"發生錯誤，請稍後再試";P({text:w,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}g.value=!1};r();const f=()=>{b.value=1,r()};return(s,l)=>{const V=Re("VueFileAgent");return le(),Ae(q,null,[t(Je,null,{default:d(()=>[t(Qe,null,{default:d(()=>[t(W,{cols:"12"},{default:d(()=>[ra]),_:1}),t(ea),t(W,{cols:"12"},{default:d(()=>[t(E,{color:"green",onClick:l[0]||(l[0]=a=>h())},{default:d(()=>[G("新增商品")]),_:1})]),_:1}),t(W,{cols:"12"},{default:d(()=>[t(aa,{"items-per-page":U.value,"onUpdate:itemsPerPage":[l[2]||(l[2]=a=>U.value=a),r],"sort-by":p.value,"onUpdate:sortBy":[l[3]||(l[3]=a=>p.value=a),r],page:b.value,"onUpdate:page":[l[4]||(l[4]=a=>b.value=a),r],items:B.value,headers:F,loading:g.value,"items-length":o.value,search:v.value,hover:""},{top:d(()=>[t(Y,{label:"搜尋","append-icon":"mdi-magnify",modelValue:v.value,"onUpdate:modelValue":l[1]||(l[1]=a=>v.value=a),"onClick:append":f,onKeydown:De(f,["enter"])},null,8,["modelValue"])]),"item.image":d(({item:a})=>[t(Ne,{src:a.image,height:"50px"},null,8,["src"])]),"item.sell":d(({item:a})=>[a.sell?(le(),_e(Ke,{key:0,icon:"mdi-check"})):ze("",!0)]),"item.edit":d(({item:a})=>[t(E,{icon:"mdi-pencil",variant:"text",color:"blue",onClick:n=>h(a)},null,8,["onClick"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"])]),_:1})]),_:1})]),_:1}),t(Ue,{modelValue:m.value,"onUpdate:modelValue":l[12]||(l[12]=a=>m.value=a),persistent:"",width:"500px"},{default:d(()=>[t(la,{disabled:u(A),onSubmit:He(u(j),["prevent"])},{default:d(()=>[t($e,null,{default:d(()=>[t(Ee,null,{default:d(()=>[G(Ge(i.value===""?"新增商品":"編輯商品"),1)]),_:1}),t(qe,null,{default:d(()=>[t(Y,{label:"名稱",modelValue:u(x).value.value,"onUpdate:modelValue":l[5]||(l[5]=a=>u(x).value.value=a),"error-messages":u(x).errorMessage.value},null,8,["modelValue","error-messages"]),t(Y,{label:"價格",type:"number",min:"0",modelValue:u(S).value.value,"onUpdate:modelValue":l[6]||(l[6]=a=>u(S).value.value=a),"error-messages":u(S).errorMessage.value},null,8,["modelValue","error-messages"]),t(oa,{label:"分類",items:_,modelValue:u(I).value.value,"onUpdate:modelValue":l[7]||(l[7]=a=>u(I).value.value=a),"error-messages":u(I).errorMessage.value},null,8,["modelValue","error-messages"]),t(ta,{label:"上架",modelValue:u(k).value.value,"onUpdate:modelValue":l[8]||(l[8]=a=>u(k).value.value=a),"error-messages":u(k).errorMessage.value},null,8,["modelValue","error-messages"]),t(sa,{label:"說明",modelValue:u(y).value.value,"onUpdate:modelValue":l[9]||(l[9]=a=>u(y).value.value=a),"error-messages":u(y).errorMessage.value},null,8,["modelValue","error-messages"]),t(V,{modelValue:C.value,"onUpdate:modelValue":l[10]||(l[10]=a=>C.value=a),rawModelValue:H.value,"onUpdate:rawModelValue":l[11]||(l[11]=a=>H.value=a),accept:"image/jpeg,image/png",deletable:"","error-text":{type:"檔案格式不支援",size:"檔案超過 1MB 大小限制"},"help-text":"選擇檔案或拖曳到這裡","max-files":1,"max-size":"1MB",ref_key:"fileAgent",ref:R},null,8,["modelValue","rawModelValue"])]),_:1}),t(Oe,null,{default:d(()=>[t(Le),t(E,{color:"red",disabled:u(A),onClick:N},{default:d(()=>[G("取消")]),_:1},8,["disabled"]),t(E,{color:"green",type:"submit",loading:u(A)},{default:d(()=>[G("送出")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64)}}};export{ya as default};
